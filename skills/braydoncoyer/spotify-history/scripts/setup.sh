#!/usr/bin/env bash
set -e

# ============================================================================
# Spotify History æŠ€èƒ½è®¾ç½®è„šæœ¬
# 
# åŠŸèƒ½è¯´æ˜Žï¼š
# æ­¤è„šæœ¬å¼•å¯¼ç”¨æˆ·å®Œæˆ Spotify History æŠ€èƒ½çš„åˆå§‹è®¾ç½®ï¼ŒåŒ…æ‹¬ï¼š
# 1. åˆ›å»º Spotify å¼€å‘è€…åº”ç”¨
# 2. è¾“å…¥å®¢æˆ·ç«¯å‡­æ®
# 3. è¿è¡Œ OAuth æŽˆæƒæµç¨‹
# ============================================================================

# èŽ·å–è„šæœ¬æ‰€åœ¨ç›®å½•è·¯å¾„
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
# èŽ·å–æŠ€èƒ½ç›®å½•ï¼ˆä¸Šä¸€çº§ç›®å½•ï¼‰
SKILL_DIR="$(dirname "$SCRIPT_DIR")"
# èŽ·å–å·¥ä½œåŒºç›®å½•ï¼ˆå†ä¸Šä¸€çº§ï¼‰
WORKSPACE_DIR="$(dirname "$(dirname "$SKILL_DIR")")"
# å‡­æ®æ–‡ä»¶ç›®å½•å’Œè·¯å¾„
CREDS_DIR="$WORKSPACE_DIR/credentials"
CREDS_FILE="$CREDS_DIR/spotify.json"

echo "ðŸŽµ Spotify History æŠ€èƒ½è®¾ç½®"
echo "================================"
echo

# ----------------------------------------------------------------------------
# æ£€æŸ¥æ˜¯å¦å·²è®¾ç½®
# ----------------------------------------------------------------------------
if [ -f "$CREDS_FILE" ]; then
    echo "âœ“ å‡­æ®å·²å­˜åœ¨äºŽï¼š$CREDS_FILE"
    read -p "è¦†ç›–çŽ°æœ‰å‡­æ®ï¼Ÿ(y/N): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "ä¿ç•™çŽ°æœ‰å‡­æ®ã€‚"
        exit 0
    fi
fi

echo "æ­¥éª¤ 1ï¼šåˆ›å»º Spotify å¼€å‘è€…åº”ç”¨"
echo "-------------------------------------"
echo "1. è®¿é—®ï¼šhttps://developer.spotify.com/dashboard"
echo "2. ç‚¹å‡»'åˆ›å»ºåº”ç”¨'"
echo "3. å¡«å†™ä¿¡æ¯ï¼š"
echo "   - åº”ç”¨åç§°ï¼šClawdï¼ˆæˆ–ä»»ä½•åç§°ï¼‰"
echo "   - åº”ç”¨æè¿°ï¼šä¸ªäººåŠ©æ‰‹é›†æˆ"
echo "   - é‡å®šå‘ URIï¼šhttp://127.0.0.1:8888/callback"
echo "4. ä¿å­˜å¹¶å¤åˆ¶æ‚¨çš„å®¢æˆ·ç«¯ ID å’Œå®¢æˆ·ç«¯å¯†é’¥"
echo
read -p "å‡†å¤‡å°±ç»ªåŽæŒ‰ Enter é”®ç»§ç»­..."
echo

# ----------------------------------------------------------------------------
# èŽ·å–å‡­æ®
# ----------------------------------------------------------------------------
echo "æ­¥éª¤ 2ï¼šè¾“å…¥å‡­æ®"
echo "-------------------------"
read -p "å®¢æˆ·ç«¯ ID: " CLIENT_ID
read -p "å®¢æˆ·ç«¯å¯†é’¥: " CLIENT_SECRET
echo

# ----------------------------------------------------------------------------
# éªŒè¯è¾“å…¥
# ----------------------------------------------------------------------------
if [ -z "$CLIENT_ID" ] || [ -z "$CLIENT_SECRET" ]; then
    echo "âŒ é”™è¯¯ï¼šéœ€è¦æä¾›å®¢æˆ·ç«¯ ID å’Œå¯†é’¥"
    exit 1
fi

# ----------------------------------------------------------------------------
# åˆ›å»ºå‡­æ®ç›®å½•å¹¶ä¿å­˜å‡­æ®
# ----------------------------------------------------------------------------
mkdir -p "$CREDS_DIR"

# å®‰å…¨ä¿å­˜å‡­æ®åˆ° JSON æ–‡ä»¶
cat > "$CREDS_FILE" <<EOF
{
  "client_id": "$CLIENT_ID",
  "client_secret": "$CLIENT_SECRET",
  "redirect_uri": "http://127.0.0.1:8888/callback"
}
EOF

# è®¾ç½®ä»…æ‰€æœ‰è€…å¯è¯»å†™æƒé™
chmod 600 "$CREDS_FILE"
echo "âœ“ å‡­æ®å·²ä¿å­˜åˆ°ï¼š$CREDS_FILE"
echo

# ----------------------------------------------------------------------------
# è¿è¡ŒæŽˆæƒæµç¨‹
# ----------------------------------------------------------------------------
echo "æ­¥éª¤ 3ï¼šæŽˆæƒ Spotify è®¿é—®"
echo "---------------------------------"
echo "æ­£åœ¨è¿è¡Œ OAuth æµç¨‹..."
echo

cd "$WORKSPACE_DIR"
python3 scripts/spotify-auth.py

echo
echo "âœ… è®¾ç½®å®Œæˆï¼"
echo
echo "æµ‹è¯•å‘½ä»¤ï¼š"
echo "  python3 scripts/spotify-api.py recent"
echo "  python3 scripts/spotify-api.py top-artists"
echo "  python3 scripts/spotify-api.py recommend"
echo
